//Tài li?u ???c vi?t b?i dat_a3cbq91
//B?t ??u t? ngày 18/9/2012
//N?i dung bao g?m ch? d?n và l?ch s? phát tri?n mã ngu?n.

1. Tính n?ng.
?ây là mã ngu?n vi?t cho router trong m?ng c?m bi?n không dây. Trong d? án WSAN,
router ???c chia làm 3 lo?i là Router-EMB, Router-Sensor, Router-Actor. Nhìn chung,
router-sensor và router-actor có th? k?t h?p v?i nhau. Trong h? th?ng, Router-EMB
ch? có m?t và ???c k?t n?i v?i máy tính nhúng qua giao di?n c?ng COM v?i giao th?c
truy?n thông n?i ti?p b?t ??ng b? RS232. D??i ?ây là mô t? chi ti?t v? các lo?i
router.
1.1. Router_EMB.
?ây là router có tác d?ng làm tr?m trung chuy?n thông tin gi?a các router khác v?i
máy tính nhúng. Các tính n?ng c?a Router-EMB bao g?m:
- Gia nh?p m?ng.
- Làm nhi?m v? trung gian ??y các b?n tin lên máy tính nhúng:
+ b?n tin nhi?t ?? ?? ?m ??nh kì/theo yêu c?u.
+ b?n tin tr?ng thái c?a router-sensor và router-actor: cháy r?ng, h?t n?ng l??ng,
  phát hi?n ??i t??ng xâm nh?p.
+ b?n tin xác nh?n gia nh?p m?ng.
- Làm nhi?m v? trung gian ??y l?nh t? máy tính nhúng xu?ng:
+ l?nh yêu c?u l?y d? li?u nhi?t ?? ?? ?m.
+ l?nh yêu c?u b?t/t?t van t??i.
+ l?nh yêu c?u quay kim c?a ??ng h? báo cháy.
+ l?nh quay ?? xoay camera bám sát chuy?n ??ng.
- Cho phép các node m?ng khác gia nh?p m?ng và Router-EMB lúc này xem nh? node cha.

1.2. Router-sensor.
Trong d? án WSAN, Router-sensor ???c b? trí ? 3 khu v?c CH?M SÓC LAN, C?NH BÁO CHÁY
R?NG, THEO DÕI ??NG V?T. ? khu ch?m sóc lan, sensor ???c trang b? là sensor SHT (nhi?t
?? ?? ?m). ? khu v?c c?nh báo cháy r?ng, sensor ???c tr?ng b? là sensor SHT và sensor
MQ6 (c?m bi?n khói). ? khu theo dõi ??ng v?t, sensor ???c tr?ng b? là sensor PIR (c?m bi?n
h?ng ngo?i th? ??ng) và sensor MicrowaveDetect (c?m bi?n sóng ng?n). Các router-sensor
s? có m?t s? trong các tính n?ng sau:
- Tính n?ng g?i nhi?t ?? - ?? ?m:
  ?? có th? s? d?ng ???c tính n?ng n?ng này, ph?i b? comment ? ph?n #define USE_SHT
  trong file zigbee.def. Tính n?ng này g?m g?i ??nh kì và g?i theo yêu c?u.
+ G?i ??nh kì: C? sau m?t kho?ng th?i gian CYCLE_SENDING * TIMER_UNIT (s)
  router-sensor có g?n SHT s? l?y d? li?u nhi?t ?? - ?? ?m và ?óng gói d? li?u này
  ?? g?i v? Router-EMB. M?c ??nh TIMER_UNIT là 5s và chu kì g?i tin là 20 phút.
  Tuy nhiên, vi?c thay ??i chu kì g?i l?nh có th? th?c hi?n trên bo nhúng v?i các
  kho?ng th?i gian là b?i nguyên c?a 5, t? 5 phút ??n 80 phút.
+ G?i theo yêu c?u: N?u nh?n ???c l?nh l?y d? li?u nhi?t ?? - ?ô ?m t? router-emb
  thì router-sensor s? l?y d? li?u nhi?t ?? - ?? ?m t? c?m bi?n SHT và ?óng gói ??
  g?i v? bo nhúng.

- Tính n?ng phát hi?n khói:
  ?? có th? s? d?ng ???c tính n?ng này, ph?i b? comment ? ph?n #define USE_MQ6 trong
  file zigbee.def.
  C? sau TIMER_UNIT s (ho?c 2*TIMER_UNIT s n?u s? d?ng c? tính n?ng ?o ?i?n áp ngu?n),
  router-sensor s? th?c hi?n chuy?n ??i tín hi?u ?i?n áp t? c?m bi?n MQ6 sang d?ng s?.
  Sau ?ó, nó s? so sánh giá tr? nó ?o ???c v?i m?t ng??ng ???c tính toán t? lúc b?t
  ??u ch?y. Ng??ng này s? khác nhau v?i các môi tr??ng khác nhau. N?u giá tr? ?o ???c
  v??t ng??ng, m?t c?nh báo v? m?t v? cháy ???c g?i t?i router-emb.

- Tính n?ng ?o ?i?n áp ngu?n:
  ?ê có th? s? d?ng tính n?ng này, ph?i b? comment ? ph?n #define USE_WARNING_LOW_POWER.
  C? sau TIMER_UNIT s (ho?c 2*TIMER_UNIT s n?u s? d?ng c? tính n?ng phát hi?n khói),
  router-sensor s? th?c hi?n chuy?n ??i tín hi?u ?i?n áp t? diode zener. N?u giá
  tr? càng l?n thì ?i?n áp VDD càng nh?, khi nó v??t ng??ng cho phép (t??ng ?ng
  2,4V) thì nó s? g?i 2 b?n tin c?nh báo h?t n?ng l??ng v? bo nhúng và t?t các module
  ADC, timer, led ?? ti?t ki?m n?ng l??ng.

1.3. Router-actor.
- Tính n?ng b?t t?t van t??i lan:
  ?? có th? s? d?ng tính n?ng này, c?n b? comment ? ph?n #define USE_CONTROL_PUMP.
  Khi nh?n ???c l?nh t? bo nhúng, router-actor s? ti?n hành g?i các l?nh xu?ng nó
  nh?n ???c cho m?ch ?i?u khi?n c? c?u. Sau khi m?ch ?i?u khi?n c? c?u b?t/t?t van
  t??i (chính là các actor) thì m?ch ?i?u khi?n c? c?u s? báo l?i cho router-actor.
  Router-actor s? ?óng gói b?n tin mà m?ch ?i?u khi?n c? c?u g?i cho nó, sau ?ó g?i
  b?n tin này t?i router-emb, xác nh?n tr?ng thái ?i?u khi?n.

- Tính n?ng ?i?u khi?n xoay kim ??ng h?.
  ?? có th? s? d?ng tính n?ng này, c?n b? comment ? ph?n #define USE_CONTROL_PUMP.
  Cách th?c ho?t ??ng gi?ng h?t nh? tính n?ng b?t/t?t van t??i.

2. L?ch s? phát tri?n.
2.1. Ngày 18/9/2012.
- Công vi?c: Phát tri?n code cho Router-EMB.
- K?t qu?:
    + K?t qu? test cho th?y, router-emb ?ã gia nh?p vào m?ng c?a coodinator khá
      ?n ??nh.
    + Các thi?t b? gia nh?p m?ng ?ã thông báo s? có m?t c?a nó v? router-emb.
    + Router-EMB ?ã nh?n ???c b?n tin nhi?t ?? ?? ?m.
- Han che:
    + Ch?a g?i l?nh ??n các node m?ng khác mà m?i ch? nh?n b?n tin t? các node khác.
      (ch?a h? tr? router-emb k?t n?i v?i máy tính).

2.2. Ngày 20/11/2012.
   Mã ngu?n ???c phát tri?n ti?p v?i các tính n?ng sau:
    - G?i b?n tin ??nh kì (ch?a d? li?u nhi?t ??, ?? ?m, ?i?n áp) v? máy tính nhúng
      v?i chu kì 20s. Chu kì này có th? thay ??i b?ng vi?c thay ??i giá tr? trong
      file zigbee.def. Vi?c ??nh th?i nh? s? d?ng b? timer3:timer2 32bit, cho phép
      tao ng?t v?i chu kì lên t?i h?n 72 ti?ng.
    - G?i b?n tin theo yêu c?u (ch? d? li?u nhi?t ??, ?? ?m, ?i?n áp) v? máy tính nhúng.
    - G?i b?n tin c?nh báo các s? ki?n (bao g?m c?nh báo cháy, c?nh báo h?t n?ng l??ng)

2.3. Ngày 27/11/2012.
    Mã ngu?n ?ã ???c test c?n th?n các tính n?ng sau:
    - g?i b?n tin ??nh kì v? bo nhúng.
    - nh?n ???c l?nh yêu c?u l?y d? li?u nhi?t ?? - ?? ?m t? bo nhúng.
    - L?y d? li?u t? c?m bi?n và g?i tr? cho bo nhúng.
    - nh?n ???c l?nh bât/t?t van t? bo nhúng.
    - g?i thông báo xác nh?n tình tr?ng b?t/t?t van.
    - g?i thông báo v? c?nh báo h?t n?ng l??ng.

2.4. Ngày 09/03/2013.
    Mã ngu?n ???c b? sung thêm các tính n?ng:
    - ?i?u ch?nh chu kì g?i d? li?u v? bo nhúng theo l?nh c?a bo nhúng.
    - ?i?u ch?nh ng??ng c?nh báo cháy r?ng theo l?nh c?a bo nhúng.
    - có tùy ch?n 2 ch? ?? active và save-energy. Ch? ?? active là ho?t ??ng bình
      th??ng nh? tr??c ?ây v?n làm. Ch? ?? save-energy là ch? ?? ti?t ki?m n?ng
      l??ng, cho phép th?c ng? tranceiver.

2.5. Ngày 18/04/2013.
    Mã ngu?n ?ã ???c tích h?p thêm tính nawg phát hi?n ??i t??ng xâm nh?p b?ng c?m
    bi?n PIR và MW.
    Ch?nh s?a l?i m?t s? bi?n và define cho h?p lý.

2.6. Ngày 15/05/2013.
    Ch?nh l?i thu?t toán c?nh báo cháy r?ng:
    - tr??c khi kh?i t?o ph?n c?ng, vi ?i?u khi?n s? trì hoãn kho?ng h?n 2000 chu
      kì l?nh ?? ??i cho tín hi?u ?i?n áp t? MQ6 ?n ??nh.
    - Sau ?ó TIMER_UNIT s (ho?c 2* TIMER_UNIT n?u dùng c? tính n?ng ?o ?i?n áp),
      vi ?i?u khi?n s? chuy?n ??i tín hi?u ?i?n áp này sang d?ng s? 8 l?n. Ti?p
      theo, giá tr? trung bình c?ng s? ???c tính. ?ây chính là giá tr? d?ng s?
      c?a tín hi?u ?i?n áp MQ6 khi môi tr??ng ch?a có cháy. Giá tr? này ???c ???c
      c?ng thêm 400 n?a ?? ra ???c ng??ng c?nh báo cháy.

3. Biên d?ch và t?i n?p xu?ng vi ?i?u khi?n.
3.1. Biên d?ch.
- C?n m? file zigbee.def ??:
+ tìm và comment ho?c uncomment ?? ch?n khu v?c tri?n khai node m?ng.
+ tìm và comment ho?c uncomment ?? ch?n ho?c h?y tính n?ng mong mu?n/không mong mu?n.
+ s?a ??i node mang là sensor hay actor, sensor là th? m?y, actor là th? m?y.
- Sau ?ó tiên hành biên d?ch.
3.2. T?i n?p.
- S? d?ng Pickit3 ?? t?i n?p file .hex xu?ng vi ?i?u khi?n.